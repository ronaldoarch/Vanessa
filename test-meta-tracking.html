<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Meta Conversions API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste do Meta Conversions API</h1>
        
        <div class="test-section">
            <h3>üìã Status da Configura√ß√£o</h3>
            <div id="config-status" class="status info">
                Verificando configura√ß√µes...
            </div>
        </div>

        <div class="test-section">
            <h3>üéØ Teste de Eventos</h3>
            <p>Clique nos bot√µes abaixo para testar diferentes eventos:</p>
            
            <button class="test-button" onclick="testEvent('PageView')">Testar PageView</button>
            <button class="test-button" onclick="testEvent('ViewContent')">Testar ViewContent</button>
            <button class="test-button" onclick="testEvent('Lead')">Testar Lead</button>
            <button class="test-button" onclick="testEvent('AddToCart')">Testar AddToCart</button>
            <button class="test-button" onclick="testEvent('Purchase')">Testar Purchase</button>
            
            <div id="event-status" class="status info">
                Aguardando teste de evento...
            </div>
        </div>

        <div class="test-section">
            <h3>üîç Teste de Configura√ß√£o</h3>
            <button class="test-button" onclick="testPixelConnection()">Testar Conex√£o do Pixel</button>
            <button class="test-button" onclick="testConversionsAPI()">Testar Conversions API</button>
            <button class="test-button" onclick="testCookies()">Testar Cookies</button>
            
            <div id="connection-status" class="status info">
                Aguardando teste de conex√£o...
            </div>
        </div>

        <div class="test-section">
            <h3>üìä Log de Eventos</h3>
            <div id="event-log" class="log">
                Log de eventos aparecer√° aqui...
            </div>
        </div>

        <div class="test-section">
            <h3>üìñ Instru√ß√µes</h3>
            <ol>
                <li>Configure suas credenciais no arquivo <code>meta-config.js</code></li>
                <li>Abra o DevTools (F12) e v√° para a aba Console</li>
                <li>Clique nos bot√µes de teste acima</li>
                <li>Verifique se os eventos aparecem no Facebook Events Manager</li>
                <li>Monitore o log de eventos abaixo</li>
            </ol>
        </div>
    </div>

    <!-- Carregar configura√ß√µes do Meta -->
    <script src="meta-config.js"></script>
    
    <!-- Facebook Pixel Code -->
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        
        // Usar configura√ß√£o externa
        fbq('init', META_CONFIG.pixelId);
        fbq('track', 'PageView');
    </script>

    <script>
        // Fun√ß√£o para adicionar log
        function addLog(message, type = 'info') {
            const log = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            log.textContent += logEntry;
            log.scrollTop = log.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Fun√ß√£o para atualizar status
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // Verificar configura√ß√µes na inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addLog('P√°gina carregada, verificando configura√ß√µes...');
            
            if (validateMetaConfig()) {
                updateStatus('config-status', '‚úÖ Configura√ß√µes v√°lidas', 'success');
                addLog('Configura√ß√µes do Meta validadas com sucesso');
            } else {
                updateStatus('config-status', '‚ùå Configura√ß√µes inv√°lidas - Verifique meta-config.js', 'error');
                addLog('ERRO: Configura√ß√µes do Meta n√£o configuradas corretamente');
            }
        });

        // Fun√ß√£o para testar eventos
        async function testEvent(eventType) {
            addLog(`Testando evento: ${eventType}`);
            updateStatus('event-status', `Testando ${eventType}...`, 'info');
            
            try {
                const eventConfig = getEventConfig(eventType);
                
                // Enviar para Facebook Pixel
                fbq('track', eventConfig.eventName, {
                    content_name: `Teste - ${eventType}`,
                    content_category: 'Test',
                    value: eventConfig.value,
                    currency: eventConfig.currency
                });
                
                addLog(`‚úÖ Evento ${eventType} enviado para Facebook Pixel`);
                
                // Tentar enviar para Conversions API
                await sendConversionEvent(eventType, {
                    content_name: `Teste - ${eventType}`,
                    content_category: 'Test'
                });
                
                updateStatus('event-status', `‚úÖ ${eventType} testado com sucesso`, 'success');
                addLog(`‚úÖ Evento ${eventType} enviado para Conversions API`);
                
            } catch (error) {
                updateStatus('event-status', `‚ùå Erro ao testar ${eventType}`, 'error');
                addLog(`‚ùå ERRO ao testar ${eventType}: ${error.message}`);
            }
        }

        // Fun√ß√£o para enviar eventos para Conversions API
        async function sendConversionEvent(eventType, customData = {}) {
            const eventConfig = getEventConfig(eventType);
            
            const event = {
                event_name: eventConfig.eventName,
                event_time: Math.floor(Date.now() / 1000),
                action_source: 'website',
                event_source_url: window.location.href,
                user_data: {
                    client_ip_address: META_CONFIG.tracking.enableIPTracking ? await getClientIP() : '',
                    client_user_agent: META_CONFIG.tracking.enableUserAgentTracking ? navigator.userAgent : '',
                    fbc: getFBC(),
                    fbp: getFBP()
                },
                custom_data: {
                    content_name: META_CONFIG.content.name,
                    content_category: META_CONFIG.content.category,
                    content_type: META_CONFIG.content.type,
                    value: eventConfig.value,
                    currency: eventConfig.currency,
                    ...customData
                }
            };

            const response = await fetch(`https://graph.facebook.com/v17.0/${META_CONFIG.pixelId}/events`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data: [event],
                    access_token: META_CONFIG.accessToken,
                    test_event_code: META_CONFIG.testEventCode
                })
            });

            const result = await response.json();
            addLog(`Conversions API Response: ${JSON.stringify(result)}`);
            return result;
        }

        // Fun√ß√µes auxiliares
        function getFBC() {
            const fbc = getCookie('_fbc');
            return fbc || '';
        }

        function getFBP() {
            const fbp = getCookie('_fbp');
            return fbp || '';
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }

        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return '';
            }
        }

        // Fun√ß√£o para testar conex√£o do pixel
        function testPixelConnection() {
            addLog('Testando conex√£o do Facebook Pixel...');
            updateStatus('connection-status', 'Testando Pixel...', 'info');
            
            if (typeof fbq !== 'undefined') {
                updateStatus('connection-status', '‚úÖ Facebook Pixel carregado', 'success');
                addLog('‚úÖ Facebook Pixel est√° funcionando');
            } else {
                updateStatus('connection-status', '‚ùå Facebook Pixel n√£o carregado', 'error');
                addLog('‚ùå ERRO: Facebook Pixel n√£o foi carregado');
            }
        }

        // Fun√ß√£o para testar Conversions API
        async function testConversionsAPI() {
            addLog('Testando Conversions API...');
            updateStatus('connection-status', 'Testando Conversions API...', 'info');
            
            try {
                const result = await sendConversionEvent('PageView', {
                    content_name: 'Teste de Conex√£o',
                    content_category: 'Test'
                });
                
                if (result.events_received > 0) {
                    updateStatus('connection-status', '‚úÖ Conversions API funcionando', 'success');
                    addLog('‚úÖ Conversions API est√° funcionando');
                } else {
                    updateStatus('connection-status', '‚ö†Ô∏è Conversions API com problemas', 'error');
                    addLog('‚ö†Ô∏è Conversions API retornou erro: ' + JSON.stringify(result));
                }
            } catch (error) {
                updateStatus('connection-status', '‚ùå Erro na Conversions API', 'error');
                addLog('‚ùå ERRO na Conversions API: ' + error.message);
            }
        }

        // Fun√ß√£o para testar cookies
        function testCookies() {
            addLog('Testando cookies do Facebook...');
            updateStatus('connection-status', 'Testando cookies...', 'info');
            
            const fbc = getFBC();
            const fbp = getFBP();
            
            if (fbc || fbp) {
                updateStatus('connection-status', '‚úÖ Cookies do Facebook encontrados', 'success');
                addLog(`‚úÖ FBC: ${fbc || 'n√£o encontrado'}`);
                addLog(`‚úÖ FBP: ${fbp || 'n√£o encontrado'}`);
            } else {
                updateStatus('connection-status', '‚ö†Ô∏è Cookies do Facebook n√£o encontrados', 'error');
                addLog('‚ö†Ô∏è Cookies do Facebook n√£o encontrados (normal em primeira visita)');
            }
        }
    </script>
</body>
</html> 